version: "3.7"
services:
  # Reverse proxy
  proxy:
    image: traefik:v2.1.0-rc3
    command: >
      --api.insecure=true
      --providers.docker
    ports:
      - "80:80" # HTTP
      - "443:443" # HTTPS
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock:ro
    labels:
      - "traefik.http.routers.proxy.rule=Host(`proxy.${DOMAIN}`)"
      - "traefik.http.services.proxy.loadbalancer.server.port=8080"
      - "traefik.http.routers.proxy.service=api@internal"
      - "traefik.http.routers.proxy.middlewares=auth"
      - "traefik.http.middlewares.auth.basicauth.users=${USERNAME}:${PASSWORD_MD5}"
  # File management
  webdav:
    image: bytemark/webdav:2.4
    environment:
      - AUTH_TYPE=Digest
      - USERNAME=${USERNAME}
      - PASSWORD=${PASSWORD}
    volumes:
      - ${DATA}:/var/lib/dav/data
    labels:
      - "traefik.http.routers.webdav.rule=Host(`webdav.${DOMAIN}`)"
      - "traefik.http.services.webdav.loadbalancer.server.port=80"
  filemanager:
    image: filebrowser/filebrowser:v2.0.16
    volumes:
      - ${DATA}:/srv
      #- ${DATA}/filemanager/database.db:/database.db
    labels:
      - "traefik.http.routers.filemanager.rule=Host(`filemanager.${DOMAIN}`)"
      - "traefik.http.services.filemanager.loadbalancer.server.port=80"
  # Torrent client
  torrent:
    # https://hub.docker.com/r/linuxserver/transmission
    image: linuxserver/transmission:2.94-r2-ls36
    environment:
      - USER=${USERNAME}
      - PASS=${PASSWORD}
    volumes:
      - ${DATA}/transmission/config:/config
      - ${DATA}/transmission/watch:/watch
      - ${DATA}/transmission/downloads:/downloads
    labels:
      - "traefik.http.routers.torrent.rule=Host(`torrent.${DOMAIN}`)"
      - "traefik.http.services.torrent.loadbalancer.server.port=9091"
  # Plex server
  plex:
    image: linuxserver/plex:1.18.2.2058-e67a4e892-ls71
    restart: unless-stopped
    volumes:
      - ${DATA}/plex/config:/config
      - ${DATA}/plex/transcode:/transcode
      - ${DATA}/transmission/downloads/complete:/data
    labels:
      - "traefik.http.routers.plex.rule=Host(`plex.${DOMAIN}`)"
      - "traefik.http.services.plex.loadbalancer.server.port=32400"
